Организация работы нескольких пользователей
===========================================

В компаниях, приобретших несколько лицензий Снегопата, встает вопрос об
организации работы нескольких пользователей, так чтобы каждый имел персональные
настройки и свежие версии скриптов, и при этом постараться уменьшить трафик
по обновлению репозитариев с сайтом Снегопата.
Вопрос возник в силу того, что Снегопат создавался с большим упором на автономную
переносимую работу и исповедует принцип "все свое ношу с собой", и ожидает, что
все нужное находится в его папке. Поэтому для удобной и правильной работы выход
один - каждый разработчик должен иметь **свою папку с Снегопатом**.

Технически организовать отдельные папки Снегопата для каждого разработчика не
сложно. Основной вопрос, возникающий при этом - синхронизация репозитариев
core-компонент снегопата и репозитария скриптов. К счастью, оба этих репозитария
обслуживаются с помощью fossil, который является **распределенной** системой
контроля версий. Что это означает на практике: вы можете организовать один
репозитарий, который будет синхронизироваться с центральным репозитарием
сайта snegopat.ru, являясь для него клиентом, и одновременно раздавать все изменения
другим локальным репозитариям, являясь для них сервером. То есть один репозитарий
скачивает изменения через интернет, и раздает их на остальные репозитарии.
При этом другие репозитарии могут и не иметь доступа к интернету.

---

Порядок развертывания снегопата в компании
------------------------------------------

Для развертывания снегопата для работы нескольких пользователей лучше придерживаться
следующей схемы:

 - Установить основные компонеты центрального Снегопата, который будет синхронизироваться
   с snegopat.ru и раздавать изменения остальным клиентам.
 - Установить копии компонент снегопата конкретным разработчикам и настроить их
   синхронизацию с вашим центральным репозитарием.

---

Установка центрального репозитария
----------------------------------

Для начала надо определиться, на какую машину устанавливать центральный репозитарий:

 - Она должна иметь доступ в интернет для возможности синхронизации с snegopat.ru,
   и к ней должны иметь доступ компьютеры остальных разработчиков для скачивания
   обновлений с локального репозитария.
 - На этой машине будет только репозитарий снегопата, а не сам снегопат, так что
   лицензий снегопата на него тратиться не будет, и это **не обязательно** должна быть
   машина одного из разработчиков.
 - Лучше поставить его на один из серверов вашей компании.
 - Возможно развернуть его под любой из ОС, поддерживаемых fossil-scm:
   Windows, Linux, BSD, MacOS и многие другие.

Я опишу пока более подробно развертывание центрального репозитария под Windows.
После того, как вы определились с машиной, проще всего выполнить на ней первоначальную
установку снегопата из файла snegopat-setup.exe. При этом будет сразу склонирован
репозитарий с сайта снегопата, уже настроенный на синхронизацию с snegopat.ru.
При установке используйте логин и пароль одной из ваших копий снегопата.

В-принципе, в установленной копии кроме папки repo и fossil.exe более ничего не нужно,
можно удалять все остальное.

Затем надо настроить раздачу локального репозитария остальным пользователям. Лучше всего это
сделать, запустив fossil в качестве сервиса. Для этого в консоли в каталоге установленного
снегопата выполните команду:
  
    fossil winsrv create snegopat -S auto -P 9456 -R "%cd%\repo"

Здесь snegopat - имя создаваемого сервиса, 9456 - порт, на котором fossil будет принимать запросы.
И имя, и порт можно задать свои, соответственно исправив дальнейшие команды.
После создания сервиса можно его запустить:

    net start snegopat

Все, fossil запущен и готов принимать запросы от клиентов.

Теперь, чтобы синхронизировать репозитарий с сайтом snegopat.ru создайте в каталоге снегопата
файл update.cmd следующего содержимого:

    @echo off
    fossil pull -R repo\core.fossil
	fossil pull -R repo\scripts.fossil

Для обновления досточно запустить этот файл. Удобнее будет, если вы настроите его запуск в
планировщике. Запускать лучше под учетной записью пользователя, выполнявшего установку.

---

Установка Снегопата для разработчика
------------------------------------

Создайте папку для установки Снегопата. Затем разместите fossil.exe в одном из каталогов,
перечисленных в PATH. Я, например, обычно размещаю fossil в папке windows. Если несколько
разработчиков работают на одном терминальном сервере, это будет достаточно сделать один раз.
После выполните в каталоге следующие команды:

    @echo off
    mkdir repo
    mkdir core
    mkdir scripts
    fossil clone http://yourserver:port/core repo\core.fossil
    fossil clone http://yourserver:port/scripts repo\scripts.fossil
	cd core
	fossil open ..\repo\core.fossil
	fossil set autosync on
	cd ..\scripts
	fossil open ..\repo\scripts.fossil
	fossil set autosync on

В командах *fossil clone* вместо *yourserver:port* подставьте адрес сервера, на котором
расположен ваш центральный репозитарий и номер порта, который вы указали при создании
сервиса.

Данные команды создадут всю структуру папок снегопата, склонируют репозитарии с локального сервера,
создадут рабочие копии скриптов и core-компонент снегопата. Вам останется только положить
snegopat.dll разработчика в эту папку. Удобнее всего разместить эти команды в cmd-файле в каталоге
центрального репозитария, и в папке пользователя просто запускать его.

Для обновления рабочей копии из основного репозитария в каталоге разработчика создайте файл update.cmd
следующего содержимого:

    @echo off
	cd core
	fossil update trunk
	cd ..\scripts
	fossil update trunk

Разработчик сможет обновлять свой репозитарий запуском этого файла.
При этом обновление будет происходить с локального центрального репозитария, соединения
с snegopat.ru не нужно.
